{"version":3,"names":["schedule_1","cov_t7ysq3j2","s","require","common_1","typeorm_1","typeorm_2","click_entity_1","url_service_1","CleanupTask","CleanupTask_1","urlService","clickRepository","logger","Logger","name","constructor","f","cleanupExpiredUrls","log","deletedCount","cleanUpExpiredUrls","error","message","stack","cleanupOldClicks","sixMonthsAgo","Date","setMonth","getMonth","result","createQueryBuilder","delete","where","date","execute","affected","hardDeleteSoftDeletedUrls","thirtyDaysAgo","setDate","getDate","andWhere","exports","__decorate","Cron","CronExpression","EVERY_DAY_AT_2AM","Promise","b","_c","Object","_d","EVERY_WEEK","_e","Injectable","__param","InjectRepository","Click","UrlService","_a","_b","Repository"],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\scheduler\\tasks\\cleanup.task.ts"],"sourcesContent":["import { Cron, CronExpression } from '@nestjs/schedule';\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { Repository, LessThan } from 'typeorm';\r\n\r\nimport { Click } from '../../analytics/entities/click.entity';\r\nimport { UrlService } from '../../url/url.service';\r\n\r\n/* \r\nCleanup Task - Automated cleanup for expired URLs & old clicks\r\n*/\r\n@Injectable()\r\nexport class CleanupTask {\r\n  private readonly logger = new Logger(CleanupTask.name);\r\n\r\n  constructor(\r\n    private readonly urlService: UrlService,\r\n    @InjectRepository(Click)\r\n    private readonly clickRepository: Repository<Click>,\r\n  ) {}\r\n\r\n  /* \r\n  Cleanup expired URLs (every 2 AM)\r\n  */\r\n  @Cron(CronExpression.EVERY_DAY_AT_2AM)\r\n  async cleanupExpiredUrls(): Promise<void> {\r\n    this.logger.log('Starting expired URLs cleanup...');\r\n\r\n    try {\r\n      const deletedCount = await this.urlService.cleanUpExpiredUrls();\r\n      this.logger.log(`Cleaned up ${deletedCount} expired URLs`);\r\n    } catch (error) {\r\n      this.logger.error(`Cleanup failed: ${error.message}`, error.stack);\r\n    }\r\n  }\r\n\r\n  /* \r\n  Cleanup old click records (older than 6 months)\r\n  */\r\n  @Cron('0 3 * * 0') // Every sunday at 3 AM\r\n  async cleanupOldClicks(): Promise<void> {\r\n    this.logger.log('Starting old clicks cleanup...');\r\n\r\n    try {\r\n      const sixMonthsAgo = new Date();\r\n      sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);\r\n\r\n      const result = await this.clickRepository\r\n        .createQueryBuilder()\r\n        .delete()\r\n        .where('createdAt < :date', { date: sixMonthsAgo })\r\n        .execute();\r\n\r\n      this.logger.log(`Cleaned up ${result.affected} old click records`);\r\n    } catch (error) {\r\n      this.logger.error(`Click cleanup failed: ${error.message}`, error.stack);\r\n    }\r\n  }\r\n\r\n  /* \r\n  Cleanup soft-deleted URLs (hard delete after 30 days)\r\n  */\r\n  @Cron(CronExpression.EVERY_WEEK)\r\n  async hardDeleteSoftDeletedUrls(): Promise<void> {\r\n    this.logger.log('Starting hard delete of soft-deleted URLs...');\r\n\r\n    try {\r\n      const thirtyDaysAgo = new Date();\r\n      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\r\n\r\n      const result = await this.urlService['urlRepository']\r\n        .createQueryBuilder()\r\n        .delete()\r\n        .where('deletedAt IS NOT NULL')\r\n        .andWhere('deletedAt < :date', { date: thirtyDaysAgo })\r\n        .execute();\r\n\r\n      this.logger.log(`Hard deleted ${result.affected} old soft-deleted URLs`);\r\n    } catch (error) {\r\n      this.logger.error(`Hard delete failed: ${error.message}`, error.stack);\r\n    }\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}