{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\unit\\url.service.spec.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\unit\\url.service.spec.ts"],"sourcesContent":["import {\r\n  ConflictException,\r\n  NotFoundException,\r\n  BadRequestException,\r\n} from '@nestjs/common';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { getRepositoryToken } from '@nestjs/typeorm';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Repository } from 'typeorm';\r\n\r\nimport { CacheService } from '../../src/common/cache/cache.service';\r\nimport { Url } from '../../src/modules/url/entities/url.entity';\r\nimport { UrlService } from '../../src/modules/url/url.service';\r\n\r\ndescribe('UrlService', () => {\r\n  let service: UrlService;\r\n  let repository: Repository<Url>;\r\n  let cacheService: CacheService;\r\n\r\n  const mockQueryBuilder = {\r\n    where: jest.fn().mockReturnThis(),\r\n    andWhere: jest.fn().mockReturnThis(),\r\n    softDelete: jest.fn().mockReturnThis(),\r\n    execute: jest.fn().mockResolvedValue({ affected: 1 }),\r\n    getMany: jest.fn().mockResolvedValue([]),\r\n  };\r\n\r\n  const mockRepository = {\r\n    findOne: jest.fn(),\r\n    find: jest.fn(),\r\n    create: jest.fn(),\r\n    save: jest.fn(),\r\n    update: jest.fn(),\r\n    softRemove: jest.fn(),\r\n    increment: jest.fn(),\r\n    createQueryBuilder: jest.fn(() => mockQueryBuilder),\r\n    manager: {\r\n      transaction: jest.fn(),\r\n    },\r\n  };\r\n\r\n  const mockCacheService = {\r\n    get: jest.fn(),\r\n    set: jest.fn(),\r\n    del: jest.fn(),\r\n    urlLookupKey: jest.fn((code) => `url:lookup:${code}`),\r\n    getTTL: jest.fn(() => 3600),\r\n  };\r\n\r\n  const mockConfigService = {\r\n    get: jest.fn((key: string) => {\r\n      const config = {\r\n        SHORT_CODE_LENGTH: 6,\r\n        BASE_URL: 'http://localhost:3000',\r\n      };\r\n      return config[key];\r\n    }),\r\n  };\r\n\r\n  beforeEach(async () => {\r\n    const module: TestingModule = await Test.createTestingModule({\r\n      providers: [\r\n        UrlService,\r\n        {\r\n          provide: getRepositoryToken(Url),\r\n          useValue: mockRepository,\r\n        },\r\n        {\r\n          provide: CacheService,\r\n          useValue: mockCacheService,\r\n        },\r\n        {\r\n          provide: ConfigService,\r\n          useValue: mockConfigService,\r\n        },\r\n      ],\r\n    }).compile();\r\n\r\n    service = module.get<UrlService>(UrlService);\r\n    repository = module.get<Repository<Url>>(getRepositoryToken(Url));\r\n    cacheService = module.get<CacheService>(CacheService);\r\n  });\r\n\r\n  afterEach(() => {\r\n    jest.clearAllMocks();\r\n  });\r\n\r\n  describe('createShortUrl', () => {\r\n    it('should create URL with random short code', async () => {\r\n      const dto = { originalUrl: 'https://example.com' };\r\n      const mockUrl = {\r\n        id: 'uuid',\r\n        shortCode: 'abc123',\r\n        originalUrl: 'https://example.com',\r\n        clickCount: 0,\r\n      };\r\n\r\n      mockRepository.findOne.mockResolvedValue(null);\r\n      mockRepository.create.mockReturnValue(mockUrl);\r\n      mockRepository.save.mockResolvedValue(mockUrl);\r\n\r\n      const result = await service.createShortUrl(dto);\r\n\r\n      expect(result.shortCode).toBeDefined();\r\n      expect(result.shortCode).toHaveLength(6);\r\n      expect(mockRepository.save).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should create URL with custom alias', async () => {\r\n      const dto = {\r\n        originalUrl: 'https://example.com',\r\n        customAlias: 'my-link',\r\n      };\r\n      const mockUrl = {\r\n        id: 'uuid',\r\n        shortCode: 'my-link',\r\n        originalUrl: 'https://example.com',\r\n      };\r\n\r\n      mockRepository.findOne.mockResolvedValue(null);\r\n      mockRepository.create.mockReturnValue(mockUrl);\r\n      mockRepository.save.mockResolvedValue(mockUrl);\r\n\r\n      const result = await service.createShortUrl(dto);\r\n\r\n      expect(result.shortCode).toBe('my-link');\r\n    });\r\n\r\n    it('should throw ConflictException for duplicate alias', async () => {\r\n      const dto = {\r\n        originalUrl: 'https://example.com',\r\n        customAlias: 'existing',\r\n      };\r\n\r\n      mockRepository.findOne.mockResolvedValue({ shortCode: 'existing' });\r\n\r\n      await expect(service.createShortUrl(dto)).rejects.toThrow(\r\n        ConflictException,\r\n      );\r\n    });\r\n\r\n    it('should reject localhost URLs', async () => {\r\n      const dto = { originalUrl: 'http://localhost:3000' };\r\n\r\n      await expect(service.createShortUrl(dto)).rejects.toThrow(\r\n        BadRequestException,\r\n      );\r\n    });\r\n\r\n    it('should hash password if provided', async () => {\r\n      const dto = {\r\n        originalUrl: 'https://example.com',\r\n        password: 'secret123',\r\n      };\r\n\r\n      mockRepository.findOne.mockResolvedValue(null);\r\n      mockRepository.create.mockReturnValue({});\r\n      mockRepository.save.mockResolvedValue({\r\n        id: 'uuid',\r\n        password: 'hashed',\r\n      });\r\n\r\n      const result = await service.createShortUrl(dto);\r\n\r\n      expect(result.password).not.toBe('secret123');\r\n    });\r\n  });\r\n\r\n  describe('getOriginal Url', () => {\r\n    it('should return URL from cache if exists', async () => {\r\n      const cachedUrl = {\r\n        shortCode: 'abc123',\r\n        originalUrl: 'https://example.com',\r\n        isActive: true,\r\n        deletedAt: null,\r\n        expiresAt: null,\r\n        maxClicks: 0,\r\n        clickCount: 0,\r\n        password: null,\r\n      };\r\n\r\n      mockCacheService.get.mockResolvedValue(cachedUrl);\r\n\r\n      const result = await service.getOriginalUrl('abc123');\r\n\r\n      expect(result).toBe('https://example.com');\r\n      expect(mockRepository.findOne).not.toHaveBeenCalled();\r\n    });\r\n\r\n    it('should query DB and cache if not in cache', async () => {\r\n      const dbUrl = {\r\n        shortCode: 'abc123',\r\n        originalUrl: 'https://example.com',\r\n        isActive: true,\r\n        deletedAt: null,\r\n        expiresAt: null,\r\n        maxClicks: 0,\r\n        clickCount: 0,\r\n        password: null,\r\n      };\r\n\r\n      mockCacheService.get.mockResolvedValue(null);\r\n      mockRepository.findOne.mockResolvedValue(dbUrl);\r\n\r\n      const result = await service.getOriginalUrl('abc123');\r\n\r\n      expect(result).toBe('https://example.com');\r\n      expect(mockRepository.findOne).toHaveBeenCalled();\r\n      expect(mockCacheService.set).toHaveBeenCalled();\r\n    });\r\n\r\n    it('should throw NotFoundException for non-existent code', async () => {\r\n      mockCacheService.get.mockResolvedValue(null);\r\n      mockRepository.findOne.mockResolvedValue(null);\r\n\r\n      await expect(service.getOriginalUrl('notfound')).rejects.toThrow(\r\n        NotFoundException,\r\n      );\r\n    });\r\n\r\n    it('should throw error for expired URL', async () => {\r\n      const expiredUrl = {\r\n        shortCode: 'abc123',\r\n        originalUrl: 'https://example.com',\r\n        isActive: true,\r\n        deletedAt: null,\r\n        expiresAt: new Date('2020-01-01'),\r\n        password: null,\r\n      };\r\n\r\n      mockCacheService.get.mockResolvedValue(null);\r\n      mockRepository.findOne.mockResolvedValue(expiredUrl);\r\n\r\n      await expect(service.getOriginalUrl('abc123')).rejects.toThrow(\r\n        BadRequestException,\r\n      );\r\n    });\r\n\r\n    it('should throw error for inactive URL', async () => {\r\n      const inactiveUrl = {\r\n        shortCode: 'abc123',\r\n        originalUrl: 'https://example.com',\r\n        isActive: false,\r\n        deletedAt: null,\r\n        expiresAt: null,\r\n        password: null,\r\n      };\r\n\r\n      mockCacheService.get.mockResolvedValue(null);\r\n      mockRepository.findOne.mockResolvedValue(inactiveUrl);\r\n\r\n      await expect(service.getOriginalUrl('abc123')).rejects.toThrow(\r\n        BadRequestException,\r\n      );\r\n    });\r\n  });\r\n\r\n  describe('updateUrl', () => {\r\n    it('should update URL and invalidate cache', async () => {\r\n      const existingUrl = {\r\n        id: 'uuid',\r\n        shortCode: 'abc123',\r\n        title: 'Old Title',\r\n      };\r\n      const updateDto = { title: 'New Title' };\r\n\r\n      mockRepository.findOne.mockResolvedValue(existingUrl);\r\n      mockRepository.save.mockResolvedValue({\r\n        ...existingUrl,\r\n        title: 'New Title',\r\n      });\r\n\r\n      await service.updateUrl('uuid', updateDto);\r\n\r\n      expect(mockRepository.save).toHaveBeenCalled();\r\n      expect(mockCacheService.del).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('deleteUrl', () => {\r\n    it('should soft delete URL and invalidate cache', async () => {\r\n      const url = {\r\n        id: 'uuid',\r\n        shortCode: 'abc123',\r\n      };\r\n\r\n      mockRepository.findOne.mockResolvedValue(url);\r\n      mockRepository.softRemove.mockResolvedValue(url);\r\n\r\n      await service.deleteUrl('uuid');\r\n\r\n      expect(mockRepository.softRemove).toHaveBeenCalled();\r\n      expect(mockCacheService.del).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('incrementClickCount', () => {\r\n    it('should increment click count and invalidate cache', async () => {\r\n      const url = { id: 'uuid', shortCode: 'abc123' };\r\n\r\n      mockRepository.increment.mockResolvedValue({});\r\n      mockRepository.findOne.mockResolvedValue(url);\r\n\r\n      await service.incrementClickCount('uuid');\r\n\r\n      expect(mockRepository.increment).toHaveBeenCalledWith(\r\n        { id: 'uuid' },\r\n        'clickCount',\r\n        1,\r\n      );\r\n      expect(mockCacheService.del).toHaveBeenCalled();\r\n    });\r\n  });\r\n\r\n  describe('cleanupExpiredUrls', () => {\r\n    it('should delete expired URLs', async () => {\r\n      const result = await service.cleanUpExpiredUrls();\r\n\r\n      expect(mockRepository.createQueryBuilder).toHaveBeenCalled();\r\n      expect(mockQueryBuilder.softDelete).toHaveBeenCalled();\r\n      expect(mockQueryBuilder.where).toHaveBeenCalledWith(\r\n        'expiresAt < :now',\r\n        expect.any(Object),\r\n      );\r\n      expect(mockQueryBuilder.andWhere).toHaveBeenCalledWith(\r\n        'isActive = :isActive',\r\n        { isActive: true },\r\n      );\r\n      expect(mockQueryBuilder.execute).toHaveBeenCalled();\r\n      expect(result).toBe(1);\r\n    });\r\n  });\r\n});\r\n"],"version":3}