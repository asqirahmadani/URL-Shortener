{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\e2e\\setup.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\e2e\\setup.ts"],"sourcesContent":["import { ConfigModule, ConfigService } from '@nestjs/config';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { INestApplication } from '@nestjs/common';\r\nimport { ValidationPipe } from '@nestjs/common';\r\nimport { TypeOrmModule } from '@nestjs/typeorm';\r\nimport { BullModule } from '@nestjs/bullmq';\r\nimport { DataSource } from 'typeorm';\r\nimport * as dotenv from 'dotenv';\r\nimport * as path from 'path';\r\n\r\n// import modules\r\nimport { RateLimitModule } from '../../src/modules/rate-limit/rate-limit.module';\r\nimport { AnalyticsModule } from '../../src/modules/analytics/analytics.module';\r\nimport { SchedulerModule } from '../../src/modules/scheduler/scheduler.module';\r\nimport { QrcodeModule } from '../../src/modules/qrcode/qrcode.module';\r\nimport { AdminModule } from '../../src/modules/admin/admin.module';\r\nimport { CacheModule } from '../../src/common/cache/cache.module';\r\nimport { AuthModule } from '../../src/modules/auth/auth.module';\r\nimport { UrlModule } from '../../src/modules/url/url.module';\r\n\r\n// import entities\r\nimport { Click } from '../../src/modules/analytics/entities/click.entity';\r\nimport { ApiKey } from '../../src/modules/auth/entities/api-key.entity';\r\nimport { User } from '../../src/modules/auth/entities/user.entity';\r\nimport { Url } from '../../src/modules/url/entities/url.entity';\r\n\r\ndotenv.config({ path: path.resolve(__dirname, '../../.env.test') });\r\n\r\nexport let app: INestApplication;\r\nexport let dataSource: DataSource;\r\n\r\n// setup before all tests\r\nbeforeAll(async () => {\r\n  const moduleFixture: TestingModule = await Test.createTestingModule({\r\n    imports: [\r\n      ConfigModule.forRoot({\r\n        isGlobal: true,\r\n        envFilePath: '.env.test',\r\n        ignoreEnvFile: false,\r\n      }),\r\n\r\n      TypeOrmModule.forRootAsync({\r\n        inject: [ConfigService],\r\n        useFactory: (configService: ConfigService) => ({\r\n          type: 'postgres',\r\n          host: configService.get('DB_HOST', 'localhost'),\r\n          port: configService.get<number>('DB_PORT', 5433),\r\n          username: configService.get('DB_USERNAME', 'test_user'),\r\n          password: configService.get('DB_PASSWORD', 'test_password'),\r\n          database: configService.get('DB_DATABASE', 'urlshortener_test_db'),\r\n          entities: [Url, User, ApiKey, Click],\r\n          synchronize: true,\r\n          dropSchema: true,\r\n          logging: false,\r\n        }),\r\n      }),\r\n\r\n      BullModule.forRootAsync({\r\n        inject: [ConfigService],\r\n        useFactory: (configService: ConfigService) => ({\r\n          connection: {\r\n            host: configService.get('REDIS_HOST', 'localhost'),\r\n            port: configService.get<number>('REDIS_PORT', 6380),\r\n            password: configService.get('REDIS_PASSWORD'),\r\n            maxRetriesPerRequest: null,\r\n            lazyConnect: true,\r\n          },\r\n        }),\r\n      }),\r\n\r\n      //   import all module\r\n      CacheModule,\r\n      UrlModule,\r\n      AnalyticsModule,\r\n      QrcodeModule,\r\n      SchedulerModule,\r\n      RateLimitModule,\r\n      AdminModule,\r\n      AuthModule,\r\n    ],\r\n  }).compile();\r\n\r\n  app = moduleFixture.createNestApplication();\r\n\r\n  app.useGlobalPipes(\r\n    new ValidationPipe({\r\n      whitelist: true,\r\n      forbidNonWhitelisted: true,\r\n      transform: true,\r\n      transformOptions: {\r\n        enableImplicitConversion: true,\r\n      },\r\n    }),\r\n  );\r\n\r\n  await app.init();\r\n\r\n  dataSource = app.get(DataSource);\r\n}, 60000);\r\n\r\nafterAll(async () => {\r\n  if (dataSource && dataSource.isInitialized) {\r\n    await dataSource.destroy();\r\n  }\r\n  if (app) {\r\n    await app.close();\r\n  }\r\n}, 10000);\r\n\r\nexport const cleanDatabase = async () => {\r\n  if (!dataSource || !dataSource.isInitialized) {\r\n    throw new Error('DataSource not initialized');\r\n  }\r\n\r\n  const entities = dataSource.entityMetadatas;\r\n\r\n  for (const entity of entities) {\r\n    const repository = dataSource.getRepository(entity.name);\r\n    await repository.query(\r\n      `TRUNCATE TABLE \"${entity.tableName}\" RESTART IDENTITY CASCADE`,\r\n    );\r\n  }\r\n};\r\n\r\nexport const wait = (ms: number) =>\r\n  new Promise((resolve) => setTimeout(resolve, ms));\r\n"],"version":3}