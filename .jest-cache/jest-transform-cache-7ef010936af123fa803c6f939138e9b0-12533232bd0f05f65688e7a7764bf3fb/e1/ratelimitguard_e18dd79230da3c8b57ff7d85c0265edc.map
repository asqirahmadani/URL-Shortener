{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\rate-limit\\guards\\rate-limit.guard.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\rate-limit\\guards\\rate-limit.guard.ts"],"sourcesContent":["import {\r\n  Injectable,\r\n  ExecutionContext,\r\n  CanActivate,\r\n  HttpException,\r\n  HttpStatus,\r\n  Logger,\r\n} from '@nestjs/common';\r\nimport { Request } from 'express';\r\nimport { Reflector } from '@nestjs/core';\r\n\r\nimport { RateLimitService } from '../rate-limit.service';\r\n\r\n/* \r\nRate Limit Guard - protect routes from abuse\r\n*/\r\n@Injectable()\r\nexport class RateLimitGuard implements CanActivate {\r\n  private readonly logger = new Logger(RateLimitGuard.name);\r\n\r\n  constructor(\r\n    private readonly rateLimitService: RateLimitService,\r\n    private readonly reflector: Reflector,\r\n  ) {}\r\n\r\n  async canActivate(context: ExecutionContext): Promise<boolean> {\r\n    const request = context.switchToHttp().getRequest<Request>();\r\n    let ip = this.getClientIP(request);\r\n    ip = this.normalizeIP(ip);\r\n\r\n    // check blacklist first\r\n    const isBlacklisted = await this.rateLimitService.isBlacklisted(ip);\r\n    if (isBlacklisted) {\r\n      throw new HttpException('IP Blocked', HttpStatus.FORBIDDEN);\r\n    }\r\n\r\n    // check whitelist - bypass rate limit\r\n    const isWhitelisted = await this.rateLimitService.isWhitelisted(ip);\r\n    if (isWhitelisted) {\r\n      return true;\r\n    }\r\n\r\n    const customLimit = this.reflector.get<{ ttl: number; max: number }>(\r\n      'rateLimit',\r\n      context.getHandler(),\r\n    );\r\n\r\n    // check rate limit\r\n    const result = await this.rateLimitService.checkRateLimit(ip, customLimit);\r\n\r\n    // set response headers (informational)\r\n    const response = context.switchToHttp().getResponse();\r\n    response.setHeader('X-RateLimit-Limit', result.limit);\r\n    response.setHeader('X-RateLimit-Remaining', result.remaining);\r\n    response.setHeader('X-RateLimit-Reset', result.resetAt.toISOString());\r\n\r\n    if (!result.allowed) {\r\n      throw new HttpException(\r\n        {\r\n          statusCode: HttpStatus.TOO_MANY_REQUESTS,\r\n          message: 'Too many requests, please try again later',\r\n          retryAfter: result.resetAt,\r\n        },\r\n        HttpStatus.TOO_MANY_REQUESTS,\r\n      );\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  private getClientIP(request: Request): string {\r\n    const forwarded = request.headers['x-forwarded-for'];\r\n    if (forwarded) {\r\n      const ips = (forwarded as string).split(',');\r\n      this.logger.debug(`IP from x-forwarded-for: ${ips[0].trim()}`);\r\n      return ips[0].trim();\r\n    }\r\n\r\n    const realIP = request.headers['x-real-ip'];\r\n    if (realIP) {\r\n      this.logger.debug(`IP from x-real-ip: ${realIP}`);\r\n      return realIP as string;\r\n    }\r\n\r\n    const ip = request.ip || request.socket.remoteAddress || '127.0.0.1';\r\n    this.logger.debug(`IP from socket: ${ip}`);\r\n    return ip;\r\n  }\r\n\r\n  private normalizeIP(ip: string): string {\r\n    if (ip.startsWith('::ffff:')) {\r\n      return ip.substring(7);\r\n    }\r\n\r\n    if (ip.startsWith('::') && ip.includes('.')) {\r\n      return ip.substring(2); // Remove '::' prefix\r\n    }\r\n\r\n    return ip;\r\n  }\r\n}\r\n"],"version":3}