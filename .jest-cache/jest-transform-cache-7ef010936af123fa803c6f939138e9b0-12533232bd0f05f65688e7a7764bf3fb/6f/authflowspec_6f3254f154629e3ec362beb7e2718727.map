{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\integration\\auth.flow.spec.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\integration\\auth.flow.spec.ts"],"sourcesContent":["import { ConfigModule, ConfigService } from '@nestjs/config';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { getRepositoryToken } from '@nestjs/typeorm';\r\nimport { INestApplication } from '@nestjs/common';\r\nimport { TypeOrmModule } from '@nestjs/typeorm';\r\nimport { JwtModule } from '@nestjs/jwt';\r\nimport { Repository } from 'typeorm';\r\nimport * as dotenv from 'dotenv';\r\nimport * as path from 'path';\r\n\r\nimport { User, UserRole } from '../../src/modules/auth/entities/user.entity';\r\nimport { Click } from '../../src/modules/analytics/entities/click.entity';\r\nimport { ApiKey } from '../../src/modules/auth/entities/api-key.entity';\r\nimport { Url } from '../../src/modules/url/entities/url.entity';\r\n\r\nimport { RateLimitGuard } from '../../src/modules/rate-limit/guards/rate-limit.guard';\r\nimport { AuthService } from '../../src/modules/auth/auth.service';\r\nimport { AuthModule } from '../../src/modules/auth/auth.module';\r\n\r\ndotenv.config({ path: path.resolve(__dirname, '../../.env.test') });\r\n\r\ndescribe('Authentication FLow (Integration)', () => {\r\n  let app: INestApplication;\r\n  let authService: AuthService;\r\n  let userRepository: Repository<User>;\r\n  let module: TestingModule;\r\n\r\n  beforeAll(async () => {\r\n    module = await Test.createTestingModule({\r\n      imports: [\r\n        ConfigModule.forRoot({\r\n          isGlobal: true,\r\n          envFilePath: '.env.test',\r\n        }),\r\n        TypeOrmModule.forRootAsync({\r\n          imports: [ConfigModule],\r\n          inject: [ConfigService],\r\n          useFactory: (configService: ConfigService) => ({\r\n            type: 'postgres',\r\n            host: configService.get<string>('DB_HOST', 'localhost'),\r\n            port: configService.get<number>('DB_PORT', 5433),\r\n            username: configService.get<string>('DB_USERNAME', 'test'),\r\n            password: configService.get<string>('DB_PASSWORD', 'test'),\r\n            database: configService.get<string>('DB_DATABASE', 'test_db'),\r\n            entities: [User, ApiKey, Url, Click],\r\n            synchronize: true,\r\n            dropSchema: true,\r\n          }),\r\n        }),\r\n        JwtModule.register({\r\n          secret: 'test-secret',\r\n          signOptions: { expiresIn: '15m' },\r\n        }),\r\n        AuthModule,\r\n      ],\r\n    })\r\n      .overrideGuard(RateLimitGuard)\r\n      .useValue({ canActivate: () => true })\r\n      .compile();\r\n\r\n    app = module.createNestApplication();\r\n    await app.init();\r\n\r\n    authService = module.get<AuthService>(AuthService);\r\n    userRepository = module.get<Repository<User>>(getRepositoryToken(User));\r\n  });\r\n\r\n  afterAll(async () => {\r\n    if (app) {\r\n      await app.close();\r\n    }\r\n    if (module) {\r\n      await module.close();\r\n    }\r\n  });\r\n\r\n  beforeEach(async () => {\r\n    await userRepository.query('TRUNCATE \"users\" CASCADE');\r\n  });\r\n\r\n  describe('User Registration Flow', () => {\r\n    it('should register new user and return tokens', async () => {\r\n      const registerDto = {\r\n        email: 'test@example.com',\r\n        name: 'Test User',\r\n        password: 'Password123!',\r\n      };\r\n\r\n      const result = await authService.register(registerDto);\r\n\r\n      expect(result.user).toBeDefined();\r\n      expect(result.user.email).toBe('test@example.com');\r\n      expect(result.user.role).toBe(UserRole.USER);\r\n      expect(result.accessToken).toBeDefined();\r\n      expect(result.refreshToken).toBeDefined();\r\n\r\n      // Verify user in database\r\n      const dbUser = await userRepository.findOne({\r\n        where: { email: 'test@example.com' },\r\n      });\r\n\r\n      expect(dbUser).toBeDefined();\r\n      expect(dbUser!.password).not.toBe('Password123!'); // Should be hashed\r\n      expect(dbUser!.isActive).toBe(true);\r\n    });\r\n\r\n    it('should prevent duplicate email registration', async () => {\r\n      await authService.register({\r\n        email: 'test@example.com',\r\n        name: 'User 1',\r\n        password: 'Password123!',\r\n      });\r\n\r\n      await expect(\r\n        authService.register({\r\n          email: 'test@example.com',\r\n          name: 'User 2',\r\n          password: 'Password456!',\r\n        }),\r\n      ).rejects.toThrow('Email already registered!');\r\n\r\n      // Verify only one user exists\r\n      const count = await userRepository.count({\r\n        where: { email: 'test@example.com' },\r\n      });\r\n      expect(count).toBe(1);\r\n    });\r\n  });\r\n\r\n  describe('Login Flow', () => {\r\n    beforeEach(async () => {\r\n      await authService.register({\r\n        email: 'login@example.com',\r\n        name: 'Login User',\r\n        password: 'Password123!',\r\n      });\r\n    });\r\n\r\n    it('should login user with correct credentials', async () => {\r\n      const result = await authService.login({\r\n        email: 'login@example.com',\r\n        password: 'Password123!',\r\n      });\r\n\r\n      expect(result.user).toBeDefined();\r\n      expect(result.accessToken).toBeDefined();\r\n      expect(result.refreshToken).toBeDefined();\r\n\r\n      // Verify lastLoginAt updated\r\n      const user = await userRepository.findOne({\r\n        where: { email: 'login@example.com' },\r\n      });\r\n      expect(user!.lastLoginAt).toBeDefined();\r\n    });\r\n\r\n    it('should reject invalid email', async () => {\r\n      await expect(\r\n        authService.login({\r\n          email: 'wrong@example.com',\r\n          password: 'Password123!',\r\n        }),\r\n      ).rejects.toThrow('Email or password is wrong!');\r\n    });\r\n\r\n    it('should reject invalid password', async () => {\r\n      await expect(\r\n        authService.login({\r\n          email: 'login@example.com',\r\n          password: 'WrongPassword!',\r\n        }),\r\n      ).rejects.toThrow('Email or password is wrong!');\r\n    });\r\n\r\n    it('should reject login for inactive user', async () => {\r\n      // Deactivate user\r\n      await userRepository.update(\r\n        { email: 'login@example.com' },\r\n        { isActive: false },\r\n      );\r\n\r\n      await expect(\r\n        authService.login({\r\n          email: 'login@example.com',\r\n          password: 'Password123!',\r\n        }),\r\n      ).rejects.toThrow('Account is inactive');\r\n    });\r\n  });\r\n\r\n  describe('Token Refresh Flow', () => {\r\n    it('should refresh access token with valid refresh token', async () => {\r\n      // Register and get tokens\r\n      const registerResult = await authService.register({\r\n        email: 'refresh@example.com',\r\n        name: 'Refresh User',\r\n        password: 'Password123!',\r\n      });\r\n\r\n      const { refreshToken } = registerResult;\r\n\r\n      // Add delay to ensure iat is different\r\n      await new Promise((resolve) => setTimeout(resolve, 1100));\r\n\r\n      // Refresh tokens\r\n      const refreshResult = await authService.refreshAccessToken(refreshToken);\r\n\r\n      expect(refreshResult.accessToken).toBeDefined();\r\n      expect(refreshResult.refreshToken).toBeDefined();\r\n      expect(refreshResult.accessToken).not.toBe(registerResult.accessToken);\r\n    });\r\n\r\n    it('should reject invalid refresh token', async () => {\r\n      await expect(\r\n        authService.refreshAccessToken('invalid-token'),\r\n      ).rejects.toThrow('Invalid refresh token');\r\n    });\r\n  });\r\n\r\n  describe('Logout Flow', () => {\r\n    it('should clear refresh token on logout', async () => {\r\n      const registerResult = await authService.register({\r\n        email: 'logout@example.com',\r\n        name: 'Logout User',\r\n        password: 'Password123!',\r\n      });\r\n      const userId = registerResult.user.id;\r\n\r\n      // Logout\r\n      await authService.logout(userId);\r\n\r\n      // Verify refresh token cleared\r\n      const user = await userRepository.findOne({ where: { id: userId } });\r\n      expect(user!.refreshToken).toBeNull();\r\n\r\n      // Try to use old refresh token should fail\r\n      await expect(\r\n        authService.refreshAccessToken(registerResult.refreshToken),\r\n      ).rejects.toThrow();\r\n    });\r\n  });\r\n\r\n  describe('Complete Auth Flow', () => {\r\n    it('should handle register -> login -> refresh -> logout', async () => {\r\n      // 1. Register\r\n      const registerResult = await authService.register({\r\n        email: 'complete@example.com',\r\n        name: 'Complete User',\r\n        password: 'Password123!',\r\n      });\r\n      expect(registerResult.user).toBeDefined();\r\n      const userId = registerResult.user.id;\r\n\r\n      // 2. Logout (clear first session)\r\n      await authService.logout(userId);\r\n\r\n      // 3. Login\r\n      const loginResult = await authService.login({\r\n        email: 'complete@example.com',\r\n        password: 'Password123!',\r\n      });\r\n\r\n      expect(loginResult.accessToken).toBeDefined();\r\n\r\n      // 4. Refresh token\r\n      const refreshResult = await authService.refreshAccessToken(\r\n        loginResult.refreshToken,\r\n      );\r\n\r\n      expect(refreshResult.accessToken).toBeDefined();\r\n\r\n      // 5. Final logout\r\n      await authService.logout(userId);\r\n\r\n      // Verify refresh token cleared\r\n      const user = await userRepository.findOne({ where: { id: userId } });\r\n      expect(user!.refreshToken).toBeNull();\r\n    });\r\n  });\r\n});\r\n"],"version":3}