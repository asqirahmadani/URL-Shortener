{"version":3,"names":["schedule_1","cov_qwe5xw880","s","require","common_1","typeorm_1","typeorm_2","click_entity_1","url_entity_1","SyncCountsTask","SyncCountsTask_1","urlRepository","clickRepository","logger","Logger","name","constructor","f","syncClickCounts","log","urls","find","where","clickCount","take","syncedCount","url","actualCount","count","urlId","id","b","update","error","message","stack","recalculateAnalyticsCache","debug","exports","__decorate","Cron","CronExpression","EVERY_HOUR","Promise","_c","Object","_d","Injectable","__param","InjectRepository","Url","Click","Repository","_a","_b"],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\scheduler\\tasks\\sync-count.task.ts"],"sourcesContent":["import { Cron, CronExpression } from '@nestjs/schedule';\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { Repository } from 'typeorm';\r\n\r\nimport { Click } from '../../analytics/entities/click.entity';\r\nimport { Url } from '../../url/entities/url.entity';\r\n\r\n/* \r\nSync Count Task - Synchronized cached click counts with actual DB\r\n*/\r\n@Injectable()\r\nexport class SyncCountsTask {\r\n  private readonly logger = new Logger(SyncCountsTask.name);\r\n\r\n  constructor(\r\n    @InjectRepository(Url)\r\n    private readonly urlRepository: Repository<Url>,\r\n    @InjectRepository(Click)\r\n    private readonly clickRepository: Repository<Click>,\r\n  ) {}\r\n\r\n  /* \r\n  Sync click counts (every hour)\r\n  */\r\n  @Cron(CronExpression.EVERY_HOUR)\r\n  async syncClickCounts(): Promise<void> {\r\n    this.logger.log('Starting click count synchronization...');\r\n\r\n    try {\r\n      // Get all URLs with clicks\r\n      const urls = await this.urlRepository.find({\r\n        where: { clickCount: 0 },\r\n        take: 1000,\r\n      });\r\n\r\n      let syncedCount = 0;\r\n\r\n      for (const url of urls) {\r\n        // Count actual clicks in DB\r\n        const actualCount = await this.clickRepository.count({\r\n          where: { urlId: url.id },\r\n        });\r\n\r\n        // Update if different\r\n        if (url.clickCount !== actualCount) {\r\n          await this.urlRepository.update(url.id, {\r\n            clickCount: actualCount,\r\n          });\r\n          syncedCount++;\r\n        }\r\n      }\r\n\r\n      this.logger.log(`Synced ${syncedCount} URL click counts`);\r\n    } catch (error) {\r\n      this.logger.error(`Count sync failed: ${error.message}`, error.stack);\r\n    }\r\n  }\r\n\r\n  /* \r\n  Recalculate analytics cache (every 15 minutes)\r\n  */\r\n  @Cron('*/15 * * * *')\r\n  async recalculateAnalyticsCache(): Promise<void> {\r\n    // TODO: Implement analytics cache warming\r\n    // Get top 100 most accessed URLs\r\n    // Pre-calculate their analytics\r\n    // Warm up cache\r\n    this.logger.debug('Analytics cache recalculation (TODO)');\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,MAAAA,UAAA;AAAA;AAAA,CAAAC,aAAA,GAAAC,CAAA,QAAAC,OAAA;AACA,MAAAC,QAAA;AAAA;AAAA,CAAAH,aAAA,GAAAC,CAAA,QAAAC,OAAA;AACA,MAAAE,SAAA;AAAA;AAAA,CAAAJ,aAAA,GAAAC,CAAA,QAAAC,OAAA;AACA,MAAAG,SAAA;AAAA;AAAA,CAAAL,aAAA,GAAAC,CAAA,QAAAC,OAAA;AAEA,MAAAI,cAAA;AAAA;AAAA,CAAAN,aAAA,GAAAC,CAAA,QAAAC,OAAA;AACA,MAAAK,YAAA;AAAA;AAAA,CAAAP,aAAA,GAAAC,CAAA,QAAAC,OAAA;AAEA;;;AAIO,IAAMM,cAAc;AAAA;AAAA,CAAAR,aAAA,GAAAC,CAAA,QAAAQ,gBAAA,GAApB,MAAMD,cAAc;EAKNE,aAAA;EAEAC,eAAA;EANFC,MAAM;EAAA;EAAA,CAAAZ,aAAA,GAAAC,CAAA,QAAG,IAAIE,QAAA,CAAAU,MAAM,CAACJ,gBAAc,CAACK,IAAI,CAAC;EAEzDC,YAEmBL,aAA8B,EAE9BC,eAAkC;IAAA;IAAAX,aAAA,GAAAgB,CAAA;IAAAhB,aAAA,GAAAC,CAAA;IAFlC,KAAAS,aAAa,GAAbA,aAAa;IAAiB;IAAAV,aAAA,GAAAC,CAAA;IAE9B,KAAAU,eAAe,GAAfA,eAAe;EAC/B;EAEH;;;EAIM,MAAAM,eAAeA,CAAA;IAAA;IAAAjB,aAAA,GAAAgB,CAAA;IAAAhB,aAAA,GAAAC,CAAA;IACnB,IAAI,CAACW,MAAM,CAACM,GAAG,CAAC,yCAAyC,CAAC;IAAC;IAAAlB,aAAA,GAAAC,CAAA;IAE3D,IAAI;MACF;MACA,MAAMkB,IAAI;MAAA;MAAA,CAAAnB,aAAA,GAAAC,CAAA,QAAG,MAAM,IAAI,CAACS,aAAa,CAACU,IAAI,CAAC;QACzCC,KAAK,EAAE;UAAEC,UAAU,EAAE;QAAC,CAAE;QACxBC,IAAI,EAAE;OACP,CAAC;MAEF,IAAIC,WAAW;MAAA;MAAA,CAAAxB,aAAA,GAAAC,CAAA,QAAG,CAAC;MAAC;MAAAD,aAAA,GAAAC,CAAA;MAEpB,KAAK,MAAMwB,GAAG,IAAIN,IAAI,EAAE;QACtB;QACA,MAAMO,WAAW;QAAA;QAAA,CAAA1B,aAAA,GAAAC,CAAA,QAAG,MAAM,IAAI,CAACU,eAAe,CAACgB,KAAK,CAAC;UACnDN,KAAK,EAAE;YAAEO,KAAK,EAAEH,GAAG,CAACI;UAAE;SACvB,CAAC;QAEF;QAAA;QAAA7B,aAAA,GAAAC,CAAA;QACA,IAAIwB,GAAG,CAACH,UAAU,KAAKI,WAAW,EAAE;UAAA;UAAA1B,aAAA,GAAA8B,CAAA;UAAA9B,aAAA,GAAAC,CAAA;UAClC,MAAM,IAAI,CAACS,aAAa,CAACqB,MAAM,CAACN,GAAG,CAACI,EAAE,EAAE;YACtCP,UAAU,EAAEI;WACb,CAAC;UAAC;UAAA1B,aAAA,GAAAC,CAAA;UACHuB,WAAW,EAAE;QACf,CAAC;QAAA;QAAA;UAAAxB,aAAA,GAAA8B,CAAA;QAAA;MACH;MAAC;MAAA9B,aAAA,GAAAC,CAAA;MAED,IAAI,CAACW,MAAM,CAACM,GAAG,CAAC,UAAUM,WAAW,mBAAmB,CAAC;IAC3D,CAAC,CAAC,OAAOQ,KAAK,EAAE;MAAA;MAAAhC,aAAA,GAAAC,CAAA;MACd,IAAI,CAACW,MAAM,CAACoB,KAAK,CAAC,sBAAsBA,KAAK,CAACC,OAAO,EAAE,EAAED,KAAK,CAACE,KAAK,CAAC;IACvE;EACF;EAEA;;;EAIM,MAAAC,yBAAyBA,CAAA;IAAA;IAAAnC,aAAA,GAAAgB,CAAA;IAAAhB,aAAA,GAAAC,CAAA;IAC7B;IACA;IACA;IACA;IACA,IAAI,CAACW,MAAM,CAACwB,KAAK,CAAC,sCAAsC,CAAC;EAC3D;CACD;AAAA;AAAApC,aAAA,GAAAC,CAAA;AA1DYoC,OAAA,CAAA7B,cAAA,GAAAA,cAAA;AAAc;AAAAR,aAAA,GAAAC,CAAA;AAcnBqC,UAAA,EADL,IAAAvC,UAAA,CAAAwC,IAAI,EAACxC,UAAA,CAAAyC,cAAc,CAACC,UAAU,CAAC,E;;oCACPC,OAAO;AAAA;AAAA,CAAA1C,aAAA,GAAA8B,CAAA,WAAPY,OAAO;AAAA;AAAA,CAAA1C,aAAA,GAAA8B,CAAA,WAAAa,EAAA;AAAA;AAAA,CAAA3C,aAAA,GAAA8B,CAAA,WAAAc,MAAA,G,oDA+B/B;AAAA;AAAA5C,aAAA,GAAAC,CAAA;AAMKqC,UAAA,EADL,IAAAvC,UAAA,CAAAwC,IAAI,EAAC,cAAc,CAAC,E;;oCACcG,OAAO;AAAA;AAAA,CAAA1C,aAAA,GAAA8B,CAAA,WAAPY,OAAO;AAAA;AAAA,CAAA1C,aAAA,GAAA8B,CAAA,WAAAe,EAAA;AAAA;AAAA,CAAA7C,aAAA,GAAA8B,CAAA,WAAAc,MAAA,G,8DAMzC;AAAA;AAAA5C,aAAA,GAAAC,CAAA;yBAzDUO,cAAc,GAAAC,gBAAA,GAAA6B,UAAA,EAD1B,IAAAnC,QAAA,CAAA2C,UAAU,GAAE,EAKRC,OAAA,QAAA3C,SAAA,CAAA4C,gBAAgB,EAACzC,YAAA,CAAA0C,GAAG,CAAC,GAErBF,OAAA,QAAA3C,SAAA,CAAA4C,gBAAgB,EAAC1C,cAAA,CAAA4C,KAAK,CAAC,G;;oCADQ7C,SAAA,CAAA8C,UAAU;AAAA;AAAA,CAAAnD,aAAA,GAAA8B,CAAA,WAAVzB,SAAA,CAAA8C,UAAU;AAAA;AAAA,CAAAnD,aAAA,GAAA8B,CAAA,WAAAsB,EAAA;AAAA;AAAA,CAAApD,aAAA,GAAA8B,CAAA,WAAAc,MAAA,WAAAS,EAAA;AAAA;AAAA,CAAArD,aAAA,GAAA8B,CAAA,kBAERzB,SAAA,CAAA8C,UAAU;AAAA;AAAA,CAAAnD,aAAA,GAAA8B,CAAA,WAAVzB,SAAA,CAAA8C,UAAU;AAAA;AAAA,CAAAnD,aAAA,GAAA8B,CAAA,WAAAuB,EAAA;AAAA;AAAA,CAAArD,aAAA,GAAA8B,CAAA,WAAAc,MAAA,I,EAPnCpC,cAAc,CA0D1B","ignoreList":[]}