{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\integration\\rate-limiting.flow.spec.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\integration\\rate-limiting.flow.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\r\nimport { ConfigModule } from '@nestjs/config';\r\nimport * as dotenv from 'dotenv';\r\nimport * as path from 'path';\r\n\r\nimport { RateLimitService } from '../../src/modules/rate-limit/rate-limit.service';\r\nimport { RateLimitModule } from '../../src/modules/rate-limit/rate-limit.module';\r\nimport { CacheModule } from '../../src/common/cache/cache.module';\r\n\r\ndotenv.config({ path: path.resolve(__dirname, '../../.env.test') });\r\n\r\ndescribe('Rate Limiting (Integration)', () => {\r\n  let rateLimitService: RateLimitService;\r\n  let module: TestingModule;\r\n\r\n  beforeAll(async () => {\r\n    module = await Test.createTestingModule({\r\n      imports: [\r\n        ConfigModule.forRoot({\r\n          isGlobal: true,\r\n          envFilePath: '.env.test',\r\n        }),\r\n        CacheModule,\r\n        RateLimitModule,\r\n      ],\r\n    }).compile();\r\n\r\n    rateLimitService = module.get<RateLimitService>(RateLimitService);\r\n  });\r\n\r\n  afterAll(async () => {\r\n    await module.close();\r\n  });\r\n\r\n  describe('Rate Limit Enforcement', () => {\r\n    it('should allow requests within limit', async () => {\r\n      const ip = `test-ip-${Date.now()}`;\r\n      const customLimit = { ttl: 60, max: 10 };\r\n\r\n      // First 10 requests should pass\r\n      for (let i = 0; i < 10; i++) {\r\n        const result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n        expect(result.allowed).toBe(true);\r\n        expect(result.remaining).toBe(10 - i - 1);\r\n      }\r\n    });\r\n\r\n    it('should block requests exceeding limit', async () => {\r\n      const ip = `test-ip-${Date.now()}`;\r\n      const customLimit = { ttl: 60, max: 10 };\r\n\r\n      // Make 10 allowed requests\r\n      for (let i = 0; i < 10; i++) {\r\n        await rateLimitService.checkRateLimit(ip, customLimit);\r\n      }\r\n\r\n      // 11th request should be blocked\r\n      const result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n      expect(result.allowed).toBe(false);\r\n      expect(result.remaining).toBe(0);\r\n    });\r\n\r\n    it('should reset limit after TTL expires', async () => {\r\n      const ip = `test-ip-${Date.now()}`;\r\n      const customLimit = { ttl: 2, max: 5 }; // 2 seconds TTL\r\n\r\n      // Use up all 5 requests\r\n      for (let i = 0; i < 5; i++) {\r\n        await rateLimitService.checkRateLimit(ip, customLimit);\r\n      }\r\n\r\n      // Should be blocked\r\n      let result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n      expect(result.allowed).toBe(false);\r\n\r\n      // Wait for TTL to expire\r\n      await new Promise((resolve) => setTimeout(resolve, 2100));\r\n\r\n      // Should be allowed again\r\n      result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n      expect(result.allowed).toBe(true);\r\n    });\r\n\r\n    it('should handle different IPs independently', async () => {\r\n      const ip1 = `test-ip-1-${Date.now()}`;\r\n      const ip2 = `test-ip-2-${Date.now()}`;\r\n      const customLimit = { ttl: 60, max: 10 };\r\n\r\n      // Use up limit for IP1\r\n      for (let i = 0; i < 10; i++) {\r\n        await rateLimitService.checkRateLimit(ip1, customLimit);\r\n      }\r\n\r\n      // IP1 should be blocked\r\n      const result1 = await rateLimitService.checkRateLimit(ip1, customLimit);\r\n      expect(result1.allowed).toBe(false);\r\n\r\n      // IP2 should still be allowed\r\n      const result2 = await rateLimitService.checkRateLimit(ip2, customLimit);\r\n      expect(result2.allowed).toBe(true);\r\n    });\r\n  });\r\n\r\n  describe('Rate Limit Reset', () => {\r\n    it('should reset rate limit for specific IP', async () => {\r\n      const ip = `test-ip-${Date.now()}`;\r\n      const customLimit = { ttl: 60, max: 10 };\r\n\r\n      // Use up limit\r\n      for (let i = 0; i < 10; i++) {\r\n        await rateLimitService.checkRateLimit(ip, customLimit);\r\n      }\r\n\r\n      // Should be blocked\r\n      let result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n      expect(result.allowed).toBe(false);\r\n\r\n      // Reset limit\r\n      await rateLimitService.resetRateLimit(ip);\r\n\r\n      // Should be allowed again\r\n      result = await rateLimitService.checkRateLimit(ip, customLimit);\r\n      expect(result.allowed).toBe(true);\r\n    });\r\n  });\r\n});\r\n"],"version":3}