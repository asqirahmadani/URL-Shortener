{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\e2e\\rate-limiting.e2e.spec.ts","mappings":"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","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\test\\e2e\\rate-limiting.e2e.spec.ts"],"sourcesContent":["import { ConfigModule, ConfigService } from '@nestjs/config';\r\nimport { Test, TestingModule } from '@nestjs/testing';\r\nimport { INestApplication } from '@nestjs/common';\r\nimport { ValidationPipe } from '@nestjs/common';\r\nimport { TypeOrmModule } from '@nestjs/typeorm';\r\nimport { BullModule } from '@nestjs/bullmq';\r\nimport * as dotenv from 'dotenv';\r\nimport request from 'supertest';\r\nimport * as path from 'path';\r\n\r\n// import modules\r\nimport { RateLimitModule } from '../../src/modules/rate-limit/rate-limit.module';\r\nimport { AnalyticsModule } from '../../src/modules/analytics/analytics.module';\r\nimport { SchedulerModule } from '../../src/modules/scheduler/scheduler.module';\r\nimport { QrcodeModule } from '../../src/modules/qrcode/qrcode.module';\r\nimport { AdminModule } from '../../src/modules/admin/admin.module';\r\nimport { CacheModule } from '../../src/common/cache/cache.module';\r\nimport { AuthModule } from '../../src/modules/auth/auth.module';\r\nimport { UrlModule } from '../../src/modules/url/url.module';\r\n\r\n// import entities\r\nimport { Click } from '../../src/modules/analytics/entities/click.entity';\r\nimport { ApiKey } from '../../src/modules/auth/entities/api-key.entity';\r\nimport { User } from '../../src/modules/auth/entities/user.entity';\r\nimport { Url } from '../../src/modules/url/entities/url.entity';\r\n\r\nimport { RateLimitService } from '../../src/modules/rate-limit/rate-limit.service';\r\nimport { CacheService } from '../../src/common/cache/cache.service';\r\nimport { cleanDatabase } from './setup';\r\n\r\ndotenv.config({ path: path.resolve(__dirname, '../../.env.test') });\r\n\r\ndescribe('Rate Limiting (E2E)', () => {\r\n  let app: INestApplication;\r\n  let accessToken: string;\r\n\r\n  beforeAll(async () => {\r\n    const moduleFixture: TestingModule = await Test.createTestingModule({\r\n      imports: [\r\n        ConfigModule.forRoot({\r\n          isGlobal: true,\r\n          envFilePath: '.env.test',\r\n          ignoreEnvFile: false,\r\n        }),\r\n\r\n        TypeOrmModule.forRootAsync({\r\n          inject: [ConfigService],\r\n          useFactory: (configService: ConfigService) => ({\r\n            type: 'postgres',\r\n            host: configService.get('DB_HOST', 'localhost'),\r\n            port: configService.get<number>('DB_PORT', 5433),\r\n            username: configService.get('DB_USERNAME', 'test_user'),\r\n            password: configService.get('DB_PASSWORD', 'test_password'),\r\n            database: configService.get('DB_DATABASE', 'urlshortener_test_db'),\r\n            entities: [Url, User, ApiKey, Click],\r\n            synchronize: true,\r\n            dropSchema: true,\r\n            logging: false,\r\n          }),\r\n        }),\r\n\r\n        BullModule.forRootAsync({\r\n          inject: [ConfigService],\r\n          useFactory: (configService: ConfigService) => ({\r\n            connection: {\r\n              host: configService.get('REDIS_HOST', 'localhost'),\r\n              port: configService.get<number>('REDIS_PORT', 6380),\r\n              password: configService.get('REDIS_PASSWORD'),\r\n              maxRetriesPerRequest: null,\r\n              lazyConnect: true,\r\n            },\r\n          }),\r\n        }),\r\n\r\n        //   import all module\r\n        CacheModule,\r\n        UrlModule,\r\n        AnalyticsModule,\r\n        QrcodeModule,\r\n        SchedulerModule,\r\n        RateLimitModule,\r\n        AdminModule,\r\n        AuthModule,\r\n      ],\r\n    }).compile();\r\n\r\n    app = moduleFixture.createNestApplication();\r\n\r\n    app.useGlobalPipes(\r\n      new ValidationPipe({\r\n        whitelist: true,\r\n        forbidNonWhitelisted: true,\r\n        transform: true,\r\n        transformOptions: {\r\n          enableImplicitConversion: true,\r\n        },\r\n      }),\r\n    );\r\n\r\n    await app.init();\r\n  });\r\n\r\n  afterAll(async () => {\r\n    await app.close();\r\n  });\r\n\r\n  beforeEach(async () => {\r\n    await cleanDatabase();\r\n\r\n    // register user\r\n    const registerResponse = await request(app.getHttpServer())\r\n      .post('/api/auth/register')\r\n      .send({\r\n        email: 'ratelimit@example.com',\r\n        name: 'Rate Limit User',\r\n        password: 'Password123!',\r\n      });\r\n\r\n    accessToken = registerResponse.body.accessToken;\r\n\r\n    const cacheService = app.get(CacheService);\r\n    await cacheService.reset();\r\n  });\r\n\r\n  describe('URL Creation Rate Limiting', () => {\r\n    beforeEach(async () => {\r\n      const rateLimitService = app.get(RateLimitService);\r\n      await rateLimitService.resetRateLimit('127.0.0.1');\r\n      await rateLimitService.resetRateLimit('::1');\r\n      await rateLimitService.resetRateLimit('::ffff:127.0.0.1');\r\n    });\r\n\r\n    it('should allow requests within limit', async () => {\r\n      // make 5 requests (assuming limit is 5 per minute)\r\n      for (let i = 0; i < 5; i++) {\r\n        const response = await request(app.getHttpServer())\r\n          .post('/api/urls')\r\n          .set('Authorization', `Bearer ${accessToken}`)\r\n          .send({\r\n            originalUrl: `https://example.com/${i}`,\r\n          })\r\n          .expect(201);\r\n\r\n        expect(response.headers).toHaveProperty('x-ratelimit-limit');\r\n        expect(response.headers).toHaveProperty('x-ratelimit-remaining');\r\n      }\r\n    });\r\n\r\n    it('should block requests exceeding limit', async () => {\r\n      // make requests up to limit\r\n      for (let i = 0; i < 5; i++) {\r\n        await request(app.getHttpServer())\r\n          .post('/api/urls')\r\n          .set('Authorization', `Bearer ${accessToken}`)\r\n          .send({\r\n            originalUrl: `https://example.com/${i}`,\r\n          })\r\n          .expect(201);\r\n      }\r\n\r\n      // next request should be blocked\r\n      const response = await request(app.getHttpServer())\r\n        .post('/api/urls')\r\n        .set('Authorization', `Bearer ${accessToken}`)\r\n        .send({\r\n          originalUrl: 'https://example.com/blocked',\r\n        })\r\n        .expect(429);\r\n\r\n      expect(response.body.message).toContain('Too many requests');\r\n      expect(response.body).toHaveProperty('retryAfter');\r\n    });\r\n\r\n    it('should include rate limit headers', async () => {\r\n      const response = await request(app.getHttpServer())\r\n        .post('/api/urls')\r\n        .set('Authorization', `Bearer ${accessToken}`)\r\n        .send({\r\n          originalUrl: 'https://example.com',\r\n        })\r\n        .expect(201);\r\n\r\n      expect(response.headers['x-ratelimit-limit']).toBeDefined();\r\n      expect(response.headers['x-ratelimit-remaining']).toBeDefined();\r\n      expect(response.headers['x-ratelimit-reset']).toBeDefined();\r\n    });\r\n  });\r\n\r\n  describe('Redirect Rate Limiting', () => {\r\n    let shortCode: string;\r\n\r\n    beforeEach(async () => {\r\n      const createResponse = await request(app.getHttpServer())\r\n        .post('/api/urls')\r\n        .set('Authorization', `Bearer ${accessToken}`)\r\n        .send({\r\n          originalUrl: 'https://example.com',\r\n        });\r\n\r\n      shortCode = createResponse.body.shortCode;\r\n    });\r\n\r\n    it('should allow multiple redirects', async () => {\r\n      // redirects typically have higher limits (e.g., 30 per minute)\r\n      for (let i = 0; i < 10; i++) {\r\n        await request(app.getHttpServer())\r\n          .get(`/${shortCode}`)\r\n\r\n          .expect(302);\r\n      }\r\n    });\r\n\r\n    it('should block excessive redirects', async () => {\r\n      // make requests up to limit (assuming 30)\r\n      for (let i = 0; i < 30; i++) {\r\n        await request(app.getHttpServer()).get(`/${shortCode}`);\r\n      }\r\n\r\n      // next request should be blocked\r\n      const response = await request(app.getHttpServer())\r\n        .get(`/${shortCode}`)\r\n        .expect(429);\r\n\r\n      expect(response.body.message).toContain('Too many requests');\r\n    });\r\n  });\r\n\r\n  describe('Authentication Rate Limiting', () => {\r\n    it('should limit login attempts', async () => {\r\n      // make multiple failed login attempts\r\n      for (let i = 0; i < 5; i++) {\r\n        const response = await request(app.getHttpServer())\r\n          .post('/api/auth/login')\r\n          .send({\r\n            email: 'ratelimit@example.com',\r\n            password: 'WrongPassword123!',\r\n          })\r\n          .expect(401);\r\n      }\r\n\r\n      // next attempt should be rate limited\r\n      const response = await request(app.getHttpServer())\r\n        .post('/api/auth/login')\r\n        .send({\r\n          email: 'ratelimit@example.com',\r\n          password: 'Password123!',\r\n        })\r\n        .expect(429);\r\n\r\n      expect(response.body.message).toContain('Too many requests');\r\n    });\r\n  });\r\n\r\n  describe('Rate Limit Reset', () => {\r\n    it('should reset rate limit after TTL expires', async () => {\r\n      // make requests up to limit\r\n      for (let i = 0; i < 5; i++) {\r\n        await request(app.getHttpServer())\r\n          .post('/api/urls')\r\n          .set('Authorization', `Bearer ${accessToken}`)\r\n          .send({\r\n            originalUrl: `https://example.com/${i}`,\r\n          })\r\n          .expect(201);\r\n      }\r\n\r\n      // should be blocked\r\n      await request(app.getHttpServer())\r\n        .post('/api/urls')\r\n        .set('Authorization', `Bearer ${accessToken}`)\r\n        .send({\r\n          originalUrl: 'https://example.com/blocked',\r\n        })\r\n        .expect(429);\r\n\r\n      // wait for TTL to expire (e.g., 60 seconds)\r\n      const ttl = 60;\r\n      await new Promise((resolve) => setTimeout(resolve, (ttl + 2) * 1000));\r\n\r\n      // should work again\r\n      await request(app.getHttpServer())\r\n        .post('/api/urls')\r\n        .set('Authorization', `Bearer ${accessToken}`)\r\n        .send({\r\n          originalUrl: 'https://example.com/after-reset',\r\n        })\r\n        .expect(201);\r\n    }, 70000); // increase test timeout\r\n  });\r\n});\r\n"],"version":3}