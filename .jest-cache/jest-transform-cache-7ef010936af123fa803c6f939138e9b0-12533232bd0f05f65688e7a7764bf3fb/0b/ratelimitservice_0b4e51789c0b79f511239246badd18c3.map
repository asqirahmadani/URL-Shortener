{"version":3,"names":["cache_manager_1","cov_2dt1cdcihq","s","require","common_1","config_1","common_2","RateLimitService","RateLimitService_1","cacheManager","configService","logger","Logger","name","ttl","maxRequests","constructor","f","get","checkRateLimit","ip","customLimit","limit","b","max","key","current","ttlRemaining","getTTL","resetAt","Date","now","warn","allowed","remaining","newCount","set","error","message","resetRateLimit","del","log","isWhitelisted","whiltelistedIPs","split","filter","Boolean","includes","isBlacklisted","blacklistedIPs","exports","__decorate","Injectable","__param","Inject","CACHE_MANAGER","ConfigService","_a","Object"],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\rate-limit\\rate-limit.service.ts"],"sourcesContent":["import { CACHE_MANAGER } from '@nestjs/cache-manager';\r\nimport { Injectable, Logger } from '@nestjs/common';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport type { Cache } from 'cache-manager';\r\nimport { Inject } from '@nestjs/common';\r\n\r\n/* \r\nRate Limit Service - Custom rate limiting with Redis\r\n*/\r\n@Injectable()\r\nexport class RateLimitService {\r\n  private readonly logger = new Logger(RateLimitService.name);\r\n  private readonly ttl: number;\r\n  private readonly maxRequests: number;\r\n\r\n  constructor(\r\n    @Inject(CACHE_MANAGER)\r\n    private readonly cacheManager: Cache,\r\n    private readonly configService: ConfigService,\r\n  ) {\r\n    this.ttl = this.configService.get<number>('RATE_LIMIT_TTL', 60);\r\n    this.maxRequests = this.configService.get<number>('RATE_LIMIT_MAX', 10);\r\n  }\r\n\r\n  /* \r\n  Check if IP is rate limited\r\n  */\r\n  async checkRateLimit(\r\n    ip: string,\r\n    customLimit?: { ttl: number; max: number },\r\n  ): Promise<{\r\n    allowed: boolean;\r\n    remaining: number;\r\n    resetAt: Date;\r\n    limit: number;\r\n  }> {\r\n    const limit = customLimit?.max || this.maxRequests;\r\n    const ttl = customLimit?.ttl || this.ttl;\r\n    const key = `ratelimit:${ip}`;\r\n\r\n    try {\r\n      const current = (await this.cacheManager.get<number>(key)) || 0;\r\n\r\n      if (current >= limit) {\r\n        // rate limited\r\n        const ttlRemaining = await this.getTTL(key);\r\n        const resetAt = new Date(Date.now() + ttlRemaining * 1000);\r\n\r\n        this.logger.warn(`Rate limit exceeded for IP: ${ip}`);\r\n\r\n        return {\r\n          allowed: false,\r\n          remaining: 0,\r\n          resetAt,\r\n          limit,\r\n        };\r\n      }\r\n\r\n      // increment count\r\n      const newCount = current + 1;\r\n      await this.cacheManager.set(key, newCount, ttl * 1000);\r\n\r\n      const ttlRemaining = await this.getTTL(key);\r\n      const resetAt = new Date(Date.now() + ttlRemaining * 1000);\r\n\r\n      return {\r\n        allowed: true,\r\n        remaining: limit - newCount,\r\n        resetAt,\r\n        limit,\r\n      };\r\n    } catch (error) {\r\n      this.logger.error(`Rate limit check failed: ${error.message}`);\r\n      return {\r\n        allowed: true,\r\n        remaining: limit,\r\n        resetAt: new Date(Date.now() + ttl * 1000),\r\n        limit,\r\n      };\r\n    }\r\n  }\r\n\r\n  /* \r\n  Reset rate limit for specific IP (admin)\r\n  */\r\n  async resetRateLimit(ip: string): Promise<void> {\r\n    const key = `ratelimit:${ip}`;\r\n    await this.cacheManager.del(key);\r\n    this.logger.log(`Reset rate limit for IP: ${ip}`);\r\n  }\r\n\r\n  /* \r\n  Get TTL for cache key\r\n  */\r\n  private async getTTL(key: string): Promise<number> {\r\n    return this.ttl;\r\n  }\r\n\r\n  /* \r\n  Check if IP is whitelisted\r\n  */\r\n  async isWhitelisted(ip: string): Promise<boolean> {\r\n    // TODO: implement whitelist check form DB/config\r\n    const whiltelistedIPs = this.configService\r\n      .get<string>('WHITELISTED_IPS', '')\r\n      .split(',')\r\n      .filter(Boolean);\r\n\r\n    return whiltelistedIPs.includes(ip);\r\n  }\r\n\r\n  /* \r\n  Check if IP is blacklisted\r\n  */\r\n  async isBlacklisted(ip: string): Promise<boolean> {\r\n    // TODO: Implement blacklist check from DB/config\r\n    const blacklistedIPs = this.configService\r\n      .get<string>('BLACKLISTED_IPS', '')\r\n      .split(',')\r\n      .filter(Boolean);\r\n\r\n    return blacklistedIPs.includes(ip);\r\n  }\r\n}\r\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;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","ignoreList":[]}