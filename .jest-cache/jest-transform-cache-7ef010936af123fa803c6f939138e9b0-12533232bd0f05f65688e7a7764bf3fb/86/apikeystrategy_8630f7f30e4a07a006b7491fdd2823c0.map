{"file":"D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\auth\\strategies\\api-key.strategy.ts","mappings":";;;;;;;;;;;;;;;;;;;AAAA,2CAAmE;AACnE,+CAAoD;AACpD,+CAAoD;AACpD,6CAAmD;AACnD,2CAA+C;AAC/C,qCAAqC;AAErC,oDAA4B;AAE5B,+DAAoD;AAEpD;;EAEE;AAEK,IAAM,cAAc,GAApB,MAAM,cAAe,SAAQ,IAAA,2BAAgB,EAAC,uBAAQ,EAAE,SAAS,CAAC;IAGpD;IACA;IAHnB,YAEmB,gBAAoC,EACpC,aAA4B;QAE7C,KAAK,CAAC;YACJ,cAAc,EAAE,yBAAU,CAAC,2BAA2B,EAAE;YACxD,gBAAgB,EAAE,KAAK;YACvB,WAAW,EAAE,aAAa,CAAC,GAAG,CAAS,YAAY,CAAE;SACtD,CAAC,CAAC;QAPc,qBAAgB,GAAhB,gBAAgB,CAAoB;QACpC,kBAAa,GAAb,aAAa,CAAe;IAO/C,CAAC;IAED,KAAK,CAAC,QAAQ,CAAC,GAAY;QACzB,8BAA8B;QAC9B,MAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,WAAW,CAAW,CAAC;QAElD,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,MAAM,IAAI,8BAAqB,CAAC,kBAAkB,CAAC,CAAC;QACtD,CAAC;QAED,2BAA2B;QAC3B,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC;YAC/C,KAAK,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE;YACzB,SAAS,EAAE,CAAC,MAAM,CAAC;SACpB,CAAC,CAAC;QAEH,wBAAwB;QACxB,IAAI,QAAQ,GAAkB,IAAI,CAAC;QACnC,KAAK,MAAM,GAAG,IAAI,OAAO,EAAE,CAAC;YAC1B,MAAM,OAAO,GAAG,MAAM,gBAAM,CAAC,OAAO,CAAC,MAAM,EAAE,GAAG,CAAC,GAAG,CAAC,CAAC;YACtD,IAAI,OAAO,EAAE,CAAC;gBACZ,QAAQ,GAAG,GAAG,CAAC;gBACf,MAAM;YACR,CAAC;QACH,CAAC;QAED,IAAI,CAAC,QAAQ,EAAE,CAAC;YACd,MAAM,IAAI,8BAAqB,CAAC,iBAAiB,CAAC,CAAC;QACrD,CAAC;QAED,mBAAmB;QACnB,IAAI,QAAQ,CAAC,SAAS,IAAI,IAAI,IAAI,EAAE,GAAG,QAAQ,CAAC,SAAS,EAAE,CAAC;YAC1D,MAAM,IAAI,8BAAqB,CAAC,iBAAiB,CAAC,CAAC;QACrD,CAAC;QAED,mBAAmB;QACnB,QAAQ,CAAC,UAAU,GAAG,IAAI,IAAI,EAAE,CAAC;QACjC,MAAM,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAE3C,8CAA8C;QAC9C,OAAO;YACL,EAAE,EAAE,QAAQ,CAAC,IAAI,CAAC,EAAE;YACpB,KAAK,EAAE,QAAQ,CAAC,IAAI,CAAC,KAAK;YAC1B,IAAI,EAAE,QAAQ,CAAC,IAAI,CAAC,IAAI;YACxB,QAAQ,EAAE,QAAQ,CAAC,EAAE;YACrB,WAAW,EAAE,QAAQ,CAAC,WAAW;SAClC,CAAC;IACJ,CAAC;CACF,CAAA;AA3DY,wCAAc;yBAAd,cAAc;IAD1B,IAAA,mBAAU,GAAE;IAGR,WAAA,IAAA,0BAAgB,EAAC,uBAAM,CAAC,CAAA;yDACU,oBAAU,oBAAV,oBAAU,oDACb,sBAAa,oBAAb,sBAAa;GAJpC,cAAc,CA2D1B","names":[],"sources":["D:\\Latihan\\Programming\\Dummy-Project\\url-shortener\\src\\modules\\auth\\strategies\\api-key.strategy.ts"],"sourcesContent":["import { Injectable, UnauthorizedException } from '@nestjs/common';\r\nimport { Strategy, ExtractJwt } from 'passport-jwt';\r\nimport { PassportStrategy } from '@nestjs/passport';\r\nimport { InjectRepository } from '@nestjs/typeorm';\r\nimport { ConfigService } from '@nestjs/config';\r\nimport { Repository } from 'typeorm';\r\nimport { Request } from 'express';\r\nimport bcrypt from 'bcrypt';\r\n\r\nimport { ApiKey } from '../entities/api-key.entity';\r\n\r\n/* \r\nAPI Key Strategy - validate API keys\r\n*/\r\n@Injectable()\r\nexport class ApiKeyStrategy extends PassportStrategy(Strategy, 'api-key') {\r\n  constructor(\r\n    @InjectRepository(ApiKey)\r\n    private readonly apiKeyRepository: Repository<ApiKey>,\r\n    private readonly configService: ConfigService,\r\n  ) {\r\n    super({\r\n      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),\r\n      ignoreExpiration: false,\r\n      secretOrKey: configService.get<string>('JWT_SECRET')!,\r\n    });\r\n  }\r\n\r\n  async validate(req: Request): Promise<any> {\r\n    // extract API key from header\r\n    const apiKey = req.headers['x-api-key'] as string;\r\n\r\n    if (!apiKey) {\r\n      throw new UnauthorizedException('API key required');\r\n    }\r\n\r\n    // find API key in database\r\n    const apiKeys = await this.apiKeyRepository.find({\r\n      where: { isActive: true },\r\n      relations: ['user'],\r\n    });\r\n\r\n    // check each hashed key\r\n    let validKey: ApiKey | null = null;\r\n    for (const key of apiKeys) {\r\n      const isValid = await bcrypt.compare(apiKey, key.key);\r\n      if (isValid) {\r\n        validKey = key;\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!validKey) {\r\n      throw new UnauthorizedException('Invalid API key');\r\n    }\r\n\r\n    // check expiration\r\n    if (validKey.expiresAt && new Date() > validKey.expiresAt) {\r\n      throw new UnauthorizedException('API key expired');\r\n    }\r\n\r\n    // update last used\r\n    validKey.lastUsedAt = new Date();\r\n    await this.apiKeyRepository.save(validKey);\r\n\r\n    // return user object with API key permissions\r\n    return {\r\n      id: validKey.user.id,\r\n      email: validKey.user.email,\r\n      role: validKey.user.role,\r\n      apiKeyId: validKey.id,\r\n      permissions: validKey.permissions,\r\n    };\r\n  }\r\n}\r\n"],"version":3}